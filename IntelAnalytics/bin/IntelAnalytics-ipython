#! /bin/bash
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
export INTEL_ANALYTICS_HOME="$DIR/.."
export INTEL_IPYTHON_EXE_HOME="/home/hadoop/.intelanalytics"
if [ -d intel_analytics ] 
	then
		export INTEL_ANALYTICS_PYTHON="$DIR/.."
else 
	export INTEL_ANALYTICS_PYTHON="$INTEL_ANALYTICS_HOME/virtpy/lib/python2.7/site-packages"
fi
export HOSTNAME=`hostname`
if [ -d /home/hadoop/IntelAnalytics/hadoop ] 
	then
		export HADOOP_HOME=/home/hadoop/IntelAnalytics/hadoop
fi
if [ -d /home/hadoop/IntelAnalytics/hbase ] 
	then
		export HBASE_HOME=/home/hadoop/IntelAnalytics/hbase
fi
if [ ! -d $INTEL_IPYTHON_EXE_HOME ]
   then
       mkdir $INTEL_IPYTHON_EXE_HOME
fi
#prepare data for ipython notebooks

ls $INTEL_ANALYTICS_HOME/notebooks/data/  | while read line;
do
   if $HADOOP_HOME/bin/hadoop fs -test -e /user/hadoop/$line ; then
        echo $line "exists"
   else
       $HADOOP_HOME/bin/hadoop fs -copyFromLocal $line /user/hadoop/$line
   fi
done

if [ `ls -lat $INTEL_ANALYTICS_HOME/notebooks/*.ipynb | wc -l` -gt 0 ]
   then
      sudo mv $INTEL_ANALYTICS_HOME/notebooks/*.ipynb  $INTEL_IPYTHON_EXE_HOME/
      sudo chown hadoop:hadoop $INTEL_IPYTHON_EXE_HOME/*.ipynb
fi

if [ -d /home/hadoop/IntelAnalytics ] && [ `whoami` != 'hadoop' ]
	then
		sudo -i -u hadoop bash -c "
	. $INTEL_ANALYTICS_HOME/virtpy/bin/activate
	ipython notebook --config=$INTEL_ANALYTICS_HOME/conf/ipython_notebook_config.py
	"
else 
	if [ -d $INTEL_ANALYTICS_HOME/virtpy ]
		then
			. $INTEL_ANALYTICS_HOME/virtpy/bin/activate
	fi
	ipython notebook --config=$INTEL_ANALYTICS_HOME/conf/ipython_notebook_config.py
fi

